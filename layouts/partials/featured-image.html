{{- /*
  Partial: featured-image.html
  Usage: {{ partial "featured-image.html" (dict "page" . "class" "blog-hero-image" "alt" .Title) }}
  - Tries to use a page bundle image (Resources.GetMatch "featured*")
  - Falls back to .Params.featured_image (external or static path)
  - Falls back to random pillar image from category folder (/images/pillars/category/*)
  - Falls back to a default image at /images/default-post.svg
  - If a page resource is found, creates resized variants and emits a responsive <img> with srcset
*/ -}}
{{- $ctx := . -}}
{{- $page := cond (isset $ctx "page") (index $ctx "page") $ctx -}}
{{- $class := cond (isset $ctx "class") (index $ctx "class") "featured-image" -}}
{{- $alt := cond (isset $ctx "alt") (index $ctx "alt") $page.Title -}}
{{- $default := "/images/default-post.svg" -}}

{{- /* Category to pillar folder mapping */ -}}
{{- $categoryFolders := dict 
    "Business & Enterprise" "business"
    "Education" "education"
    "Government" "government"
    "Community & Open Source" "opensource"
    "Personal Computing" "personal"
-}}

{{- /* Try page bundle resource first (named like featured* or any image attached) */ -}}
{{- $img := $page.Resources.GetMatch "featured*" -}}

{{- $externalSrc := "" -}}
{{- $categoryFallback := "" -}}
{{- if not $img -}}
  {{- with $page.Params.featured_image }}
    {{- $p := . -}}
    {{- if or (hasPrefix $p "http") (hasPrefix $p "//") }}
      {{- $externalSrc = $p -}}
    {{- else }}
      {{- /* Try to find a page resource by the provided filename */ -}}
      {{- $img = $page.Resources.GetMatch (printf "*%s" $p) -}}
      {{- if not $img }}
        {{- /* treat as a static or absolute path */ -}}
        {{- $externalSrc = $p -}}
      {{- end }}
    {{- end }}
  {{- end }}
  
  {{- /* If no featured image, check for category fallback with keyword-based matching */ -}}
  {{- if not $externalSrc }}
    {{- with $page.Params.categories }}
      {{- if gt (len .) 0 }}
        {{- $primaryCategory := index . 0 }}
        {{- with index $categoryFolders $primaryCategory }}
          {{- $folderName := . }}
          {{- /* Build the static path for the category folder */ -}}
          {{- $staticPath := printf "images/pillars/%s" $folderName }}
          {{- /* Scan the directory for image files */ -}}
          {{- $allImages := slice }}
          {{- $matchedImages := slice }}
          {{- $dir := os.ReadDir (printf "static/%s" $staticPath) }}
          {{- if $dir }}
            {{- range $dir }}
              {{- $ext := strings.ToLower (path.Ext .Name) }}
              {{- if in (slice ".webp" ".jpg" ".jpeg" ".png" ".gif") $ext }}
                {{- $imagePath := printf "/%s/%s" $staticPath .Name }}
                {{- $allImages = $allImages | append $imagePath }}
                
                {{- /* Try to match image filename to article tags or title */ -}}
                {{- $imageBasename := strings.ToLower (strings.TrimSuffix (path.Ext .Name) .Name) }}
                {{- $titleLower := strings.ToLower $page.Title }}
                {{- $matched := false }}
                
                {{- /* Check if image keyword appears anywhere in title or tags */ -}}
                {{- /* First check title - full word or substring match */ -}}
                {{- if strings.Contains $titleLower $imageBasename }}
                  {{- $matched = true }}
                {{- end }}
                
                {{- /* Then check tags */ -}}
                {{- if not $matched }}
                  {{- with $page.Params.tags }}
                    {{- range . }}
                      {{- $tagLower := strings.ToLower . }}
                      {{- if strings.Contains $tagLower $imageBasename }}
                        {{- $matched = true }}
                      {{- end }}
                    {{- end }}
                  {{- end }}
                {{- end }}
                
                {{- if $matched }}
                  {{- $matchedImages = $matchedImages | append $imagePath }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
          
          {{- /* Prefer matched images; fall back to random selection */ -}}
          {{- $selectedImages := $matchedImages }}
          {{- if eq (len $selectedImages) 0 }}
            {{- $selectedImages = $allImages }}
          {{- end }}
          
          {{- if gt (len $selectedImages) 0 }}
            {{- $seed := $page.Date.Unix }}
            {{- $index := mod $seed (len $selectedImages) }}
            {{- $categoryFallback = index $selectedImages $index }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if $img }}
  {{- /* Create resized variants with quality control and WebP alternatives. */ -}}
  {{- /* JPEG variants (fallback) with q=75 for good quality/size balance */ -}}
  {{- $large := $img.Resize "1200x" -}}
  {{- $medium := $img.Resize "800x" -}}
  {{- $small := $img.Resize "400x" -}}
  <img
    src="{{ $medium.RelPermalink }}"
    srcset="{{ $small.RelPermalink }} 400w, {{ $medium.RelPermalink }} 800w, {{ $large.RelPermalink }} 1200w"
    sizes="(max-width: 800px) 100vw, (max-width: 1200px) 50vw, 600px"
    class="{{ $class }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async"
  />
{{- else if $externalSrc }}
  <img
    src="{{ $externalSrc }}"
    class="{{ $class }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async"
  />
{{- else if $categoryFallback }}
  <img
    src="{{ $categoryFallback }}"
    class="{{ $class }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async"
  />
{{- else }}
  <img
    src="{{ $default }}"
    class="{{ $class }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async"
  />
{{- end }}
